{
    "dbsetup": {
        "prefix": "dbsetup",
        "body": [
            "import sqlalchemy as sa",
            "import pandas as pd",
            "import os",
            "",
            "# add run method to engine",
            "def run(self: sa.engine.Engine, sql:str) -> pd.DataFrame | None:",
            "    with self.begin() as conn:",
            "        res = conn.execute(sa.text(sql))",
            "        if res.returns_rows:",
            "            return pd.DataFrame(res.all(), columns=res.keys())",
            "",
            "sa.engine.Engine.run = run",
            "",
            "connection_string = f\"$1://$2:{os.environ['password']}@$3\"",
            "eng = sa.create_engine(connection_string)"
        ]
    },
    "dbrun0": {
        "prefix": "dbrun0",
        "body": [
            "_ = eng.run(f\"drop table $1\")"
        ]
    },
    "dbrun1": {
        "prefix": "dbrun1",
        "body": [
            "_ = eng.run(f\"select * from $1 where $2 = '$3'\")",
            "_"
        ]
    },
    "dbqry": {
        "prefix": "dbqry",
        "body": [
            "qry = f\"\"\"",
            "select",
            "    *",
            "from $1",
            "where $2 = '$3'",
            "\"\"\"",
            "",
            "df = eng.run(qry)",
            "df"
        ]
    },
    "dbhead": {
        "prefix": "dbhead",
        "body": [
            "_ = eng.run(\"select top 5 * from $1\")",
            "print(_.head().to_string())"
        ]
    },
    "dbcount1": {
        "prefix": "dbcount1",
        "body": [
            "eng.run(\"select count(*) as n from $1\").iloc[0,0]"
        ]
    },
    "dbdrop": {
        "prefix": "dbdrop",
        "body": [
            "try:",
            "    eng.run(\"drop table $1\")",
            "except Exception as e:",
            "    print(f\"Table does not exist.\")"
        ]
    },
    "dbgrp": {
        "prefix": "dbgrp",
        "body": [
            "qry = f\"\"\"",
            "select",
            "    $1,",
            "    $2,",
            "    count(1) as n,",
            "    sum(exp) as exp",
            "from $3",
            "where infokey = 'Version'",
            "group by 1,2",
            "order by 1,2",
            "\"\"\"",
            "",
            "df = eng.run(qry)",
            "df"
        ]
    },
    "dbctbl": {
        "prefix": "dbctbl",
        "body": [
            "tbl = \"$1\"",
            "",
            "try:",
            "    eng.run(f\"drop table {tbl}\")",
            "except Exception as e:",
            "    pass",
            "",
            "_ = eng.run(",
            "f\"\"\"",
            "create table {tbl} as (",
            "    select *",
            "    from $2",
            ") with data;",
            "\"\"\"",
            ")",
            "",
            "eng.run(f\"select count(*) from {tbl}\").iloc[0, 0]"
        ]
    },
    "tdsetup": {
        "prefix": "tdsetup",
        "body": [
            "import sqlalchemy as alc",
            "import pandas as pd",
            "import os",
            "",
            "# add run method to engine",
            "def run(self: alc.engine.Engine, sql:str) -> pd.DataFrame | None:",
            "    with self.begin() as conn:",
            "        res = conn.execute(alc.text(sql))",
            "        if res.returns_rows:",
            "            return pd.DataFrame(res.all(), columns=res.keys())",
            "",
            "alc.engine.Engine.run = run",
            "",
            "connection_string = f\"teradatasql://$1:{os.environ['password']}@$2\"",
            "eng = alc.create_engine(connection_string)"
        ]
    },
    "peq": {
        "prefix": "peq",
        "body": [
            "print(f\"{$0 = }\")"
        ]
    },
    "forp": {
        "prefix": "forp",
        "body": [
            "for i in $0:",
            "    print(i)"
        ]
    },
    "lcomp": {
        "prefix": "lcomp",
        "body": [
            "[i$1 for i in $2]"
        ]
    },
    "iterdir": {
        "prefix": "iterdir",
        "body": [
            "for i in ($1).iterdir():",
            "    print(i.name)"
        ]
    },
    "today": {
        "prefix": "today",
        "body": [
            "import datetime",
            "",
            "today_dt = datetime.datetime.now().strftime('%Y%m%d')",
            "today_dt"
        ]
    },
    "pdb": {
        "prefix": "pdb",
        "body": [
            "import pdb; pdb.set_trace()"
        ]
    },
    "syspath": {
        "prefix": "syspath",
        "body": [
            "from pathlib import Path",
            "import sys",
            "sys.path.append(Path().cwd().parents[0].as_posix())"
        ]
    },
    "syspathfile": {
        "prefix": "syspathfile",
        "body": [
            "from pathlib import Path",
            "import sys",
            "sys.path.append(Path(__file__).parents[1].as_posix())"
        ]
    },
    "syspathnodup": {
        "prefix": "syspathnodup",
        "body": [
            "from pathlib import Path",
            "import sys",
            "_lib_path = Path(__file__).parents[1].as_posix() # or Path().cwd() for notebook",
            "if _lib_path not in sys.path:",
            "    sys.path.append(_lib_path)"
        ]
    },
    "ipath": {
        "prefix": "ipath",
        "body": [
            "from pathlib import Path"
        ]
    },
    "setup SAS": {
        "prefix": "sassetup",
        "body": [
            "import saspy",
            "sas = saspy.SASsession()"
        ]
    },
    "Submit SAS": {
        "prefix": "sassubmit",
        "body": [
            "sas.submitLST(",
            "f\"\"\"",
            "$0",
            "run;",
            "\"\"\", method=\"listorlog\")"
        ]
    },
    "submit sas lst and log": {
        "prefix": "sassubmitlstlog",
        "body": [
            "sas.submitLST(",
            "f\"\"\"",
            "$0",
            "run;",
            "\"\"\", method=\"listandlog\")"
        ]
    },
    "sas error count": {
        "prefix": "saserrorcount",
        "body": [
            "print(f\"{sas.saslog().count('ERROR') = }\")$0"
        ]
    },
    "SAS print": {
        "prefix": "sasprint",
        "body": [
            "sas.submitLST(",
            "f\"\"\"",
            "proc print data = $1;",
            "run;",
            "\"\"\", method=\"listorlog\")$0"
        ]
    },
    "sas data head": {
        "prefix": "sasdatahead",
        "body": [
            "sas.sasdata(\"$1\",\"work$2\").head()"
        ]
    },
    "sas df": {
        "prefix": "sasdf",
        "body": [
            "df = sas.sasdata(\"$1\",\"work$2\").to_df()",
            "df$0"
        ]
    },
    "sas last log": {
        "prefix": "saslastlog",
        "body": [
            "print(sas.lastlog())$0"
        ]
    },
    "porc freq and receive df": {
        "prefix": "pfreqdf",
        "body": [
            "sas.submitLST(",
            "f\"\"\"",
            "proc freq data=$1 noprint;",
            "    tables $2 / missing out=_tmp;",
            "run;",
            "\"\"\", method=\"listonly\")",
            "df = sas.sasdata(\"_tmp\",\"work\").to_df()",
            "df.columns = df.columns.str.lower()",
            "df"
        ]
    },
    "porc summary and receive df": {
        "prefix": "psumdf",
        "body": [
            "sas.submitLST(",
            "f\"\"\"",
            "proc sort data=sashelp.cars$1 out=_sorted;",
            "    by type$2;",
            "",
            "proc summary data=_sorted;",
            "    by type$2;",
            "    var msrp$3;",
            "    output out=_tmp",
            "        mean(msrp$3) = mean_msrp$3",
            "    ;",
            "run;",
            "\"\"\", method=\"listonly\")",
            "df = sas.sasdata(\"_tmp\",\"work\").to_df()",
            "df.columns = df.columns.str.lower()",
            "df"
        ]
    },
    "sas proc sql simple version": {
        "prefix": "psqlsimple",
        "body": [
            "sas.submitLST(",
            "f\"\"\"",
            "proc sql;",
            "    select",
            "        count(*) as n",
            "    from $1",
            "    where",
            "        $0",
            "    ;",
            "quit;",
            "\"\"\", method=\"listorlog\")"
        ]
    },
    "sas proc sql full version": {
        "prefix": "psqlfull",
        "body": [
            "sas.submitLST(",
            "f\"\"\"",
            "proc sql;",
            "create table _tmp as",
            "    select",
            "        a.*,",
            "        b.*",
            "    from $1 a",
            "    left join $2 b",
            "    on",
            "        a.id = b.id and",
            "        a.date = b.date",
            "    where",
            "        $0",
            "    group by 1,2",
            "    order by 1,2",
            "    ;",
            "quit;",
            "\"\"\", method=\"listorlog\")",
            "df = sas.sasdata(\"_tmp\",\"work\").to_df()",
            "df.columns = df.columns.str.lower()",
            "df"
        ]
    },
    "iana": {
        "prefix": "iana",
        "body": [
            "import numpy as np",
            "import pandas as pd",
            "import matplotlib.pyplot as plt",
            "import matplotlib as mpl"
        ]
    },
    "istats": {
        "prefix": "istats",
        "body": [
            "import matplotlib.pyplot as plt",
            "import matplotlib as mpl",
            "import numpy as np",
            "import pandas as pd",
            "import statsmodels.api as sm",
            "from scipy import stats"
        ]
    },
    "pstr": {
        "prefix": "pstr",
        "body": [
            "print($1.to_string())"
        ]
    },
    "shapephstr": {
        "prefix": "shapephstr",
        "body": [
            "print($1.shape)",
            "print($1.head().to_string())"
        ]
    },
    "phstr": {
        "prefix": "phstr",
        "body": [
            "print($1.head().to_string())"
        ]
    },
    "mkflag": {
        "prefix": "mkflag",
        "body": [
            "res[f\"is_\"] = np.where(res[\"\"] >= 0, True, np.where(res[\"\"] < 0, False, np.nan))"
        ]
    },
    "mkflagloc": {
        "prefix": "mkflagloc",
        "body": [
            "res[f\"is_\"] = np.nan",
            "res.loc[lambda x: x[\"\"] >= 0, \"is_\"] = True",
            "res.loc[lambda x: x[\"\"] < 0, \"is_\"] = False"
        ]
    },
    "incol": {
        "prefix": "incol",
        "body": [
            "[i for i in $1.columns if '$2' in i]"
        ]
    },
    "valc": {
        "prefix": "valc",
        "body": [
            "$1.value_counts($2, dropna=False)"
        ]
    },
    "info": {
        "prefix": "info",
        "body": [
            "# vertical info view",
            "_ = pd.concat([$1.head(1).T, $1.dtypes, $1.isna().sum()], axis=1)",
            "_.columns = ['example_value', 'dtypes', 'n_null']",
            "_"
        ]
    },
    "loc": {
        "prefix": "loc",
        "body": [
            "$1.loc[lambda x:x['$2']$3, :]"
        ]
    },
    "qry": {
        "prefix": "qry",
        "body": [
            "$1.query('$2')"
        ]
    },
    "grpcol": {
        "prefix": "grpcol",
        "body": [
            "$1.groupby(\"$2\", dropna=False)[\"$3\"].mean()"
        ]
    },
    "grpdict": {
        "prefix": "grpdict",
        "body": [
            "$1.groupby(\"$2\", dropna=False).agg(",
            "    {\"$3\": [\"size\", \"sum\", \"mean\"]}",
            ")"
        ]
    },
    "grp2unstack": {
        "prefix": "grp2unstack",
        "body": [
            "$1.groupby([\"$2\", \"$3\"], dropna=False)[\"$4\"].agg(",
            "    lambda x: (len(x), float(x.mean().round(2)))",
            ").unstack()"
        ]
    },
    "grpargs": {
        "prefix": "grpargs",
        "body": [
            "$1.groupby([\"$2\", \"$3\"], dropna=False).agg(",
            "    **{",
            "        \"n\": (\"$2\", \"size\"),",
            "        \"$4_rate\": (\"$4\", \"mean\"),",
            "    }",
            ")"
        ]
    },
    "grpapply": {
        "prefix": "grpapply",
        "body": [
            "$1.groupby(['$2'], dropna=False, group_keys=False).apply(",
            "    lambda x: (x - x.mean()) / x.std()",
            ")"
        ]
    },
    "figax": {
        "prefix": "figax",
        "body": [
            "fig, ax = plt.subplots(1, 1, figsize=(12, 6))"
        ]
    },
    "mplfull": {
        "prefix": "mplfull",
        "body": [
            "fig, ax = plt.subplots(figsize=(12, 6))",
            "",
            "x_ticks = $1['$2'].astype(str)",
            "",
            "ax.plot(x_ticks, $1['$3'], alpha=0.8, marker='x', color='red', label= $1['$3'].name)",
            "ax.plot(x_ticks, $1['$4'], alpha=0.8, marker='o', color='green', label= $1['$4'].name)",
            "",
            "ax.set_title(f\"$5\", fontsize=15, fontweight='bold')",
            "",
            "ax.set_xticks(x_ticks)",
            "ax.set_xticklabels(x_ticks, rotation=45)",
            "ax.set_xlabel(x_ticks.name, loc=\"center\")",
            "",
            "ax.set_ylabel(f\"$6\", loc=\"center\")",
            "ax.yaxis.set_major_locator(mpl.ticker.MaxNLocator(nbins=10))",
            "ax.yaxis.set_major_formatter(mpl.ticker.PercentFormatter(1.0, decimals=0))",
            "ax.yaxis.set_minor_locator(mpl.ticker.AutoMinorLocator(2))",
            "ax.set_ylim(0, 1)",
            "",
            "ax.grid(True, linestyle='--', alpha=0.5)",
            "ax.spines['top'].set_visible(False)",
            "ax.spines['right'].set_visible(False)",
            "",
            "ax.legend(loc='upper left', fontsize=10, frameon=False)",
            "",
            "plt.tight_layout()"
        ]
    },
    "titanic": {
        "prefix": "titanic",
        "body": [
            "import seaborn as sns",
            "df = sns.load_dataset('titanic')",
            "print(f\"{df.shape = }\")",
            "print(df.head().to_string())"
        ]
    },
    "vspycell": {
        "prefix": "vspycell",
        "body": [
            "# %%",
            "$0"
        ]
    },
    "vsmdcell": {
        "prefix": "vsmdcell",
        "body": [
            "# %% [markdown]",
            "# ### $1",
            "# $2",
            "$0"
        ]
    }
}